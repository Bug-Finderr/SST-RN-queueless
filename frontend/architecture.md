# Frontend Architecture

Expo Router + React Query. Polling-based real-time updates.

## Navigation

```
app/
├── index.tsx       # Auth guard → redirect
├── (auth)/         # Stack: login, register
└── (tabs)/         # Tabs: services, my-tokens, admin, profile
```

**Role-gated admin tab:**
```ts
options={{ href: isAdmin ? "/(tabs)/admin" : null }}
```

---

## React Query

**Query keys** in `hooks/useAuth.ts` and `hooks/useQueue.ts`:
- `authKeys.user` — current user
- `queueKeys.services`, `queueKeys.myTokens`, `queueKeys.notifications`
- `queueKeys.queueStatus(serviceId)` — per-service status

**Polling:**
| Query | Interval |
|-------|----------|
| services, tokens | 10s |
| notifications | 30s, conditional |

**Smart notification polling:**
```ts
const hasNearTokens = tokens?.some(
  (t) => t.status === "waiting" && (t.positionInQueue ?? 0) <= 5
);
// Only polls when position ≤ 5
refetchInterval: hasNearTokens ? 30_000 : false
```

**Centralized invalidation** — `invalidateQueueData(serviceId?)` called by all mutations.

---

## Auth Flow

```
App Load → useCurrentUser() → AsyncStorage("user", "token")
                                    ↓
                            index.tsx: isAuthenticated?
                                    ↓
                    ┌───────────────┴───────────────┐
                    ↓                               ↓
            /(auth)/login                   /(tabs)/services
```

- Login/Register: stores token + user → sets query cache
- Logout: clears storage → `queryClient.clear()`

---

## API Client

`lib/api.ts` — fetch wrapper with auto Bearer token injection from AsyncStorage.

`ApiError` class carries `status` and `data` for typed error handling.

---

> _This document was generated by AI to supplement the project documentation._
